======================================================================
Optimization Log - amdahl-project.txt
======================================================================

Baseline Benchmark:
  Metrics: {'build_time_s': 18.45, 'size_mb': 488.28, 'qps': 13801.6, 'p50_ms': 0.073, 'p95_ms': 0.094, 'p99_ms': 0.109, 'recall_at_10': 0.9392}
  Duration: 23.89s
  Output: HNSW Initialization: Dim=128, M=16, M0=32, efConstruction=100, MaxLevel=6, FixedNodeSize=972 bytes, NodesPerPage=4, enable_prefetch=1
[HNSW Recovery] skip_recovery=false has_existing_meta=false
[HNSW Recovery] params_match=false
[HNSW Recovery] can_reuse_storage=false
[HNSW Recovery] Allocated new metadata page 4294967297 base_pid=4294967298 total_pages=250000
[HNSW Recovery] Metadata page updated and marked valid
Caliby version: 0.1.0.dev20251225234056
====================================================================================================
HNSW BENCHMARK: Caliby vs Usearch vs Faiss
====================================================================================================

Dataset: SIFT1M (1M vectors, 128 dimensions)
Parameters: M=16, ef_construction=100, ef_search=50

Libraries enabled:
  caliby     ✓ Enabled
  usearch    ✗ Disabled
  faiss      ✗ Disabled
✓ SIFT1M dataset already exists in ./sift1m

Loading SIFT1M dataset...
  Base vectors: (1000000, 128)
  Quer

Project Understanding Phase:
  LLM explored 7 files

======================================================================
Iteration 1/5
======================================================================
Step 3.1: Profiling
  Profiling complete - 2 hot functions found
  Top hot functions:
    - HNSW<hnsw_distance::SIMDAcceleratedL2>::searchLayer<false>: 80.17%
    - HNSW<hnsw_distance::SIMDAcceleratedL2>::addPoint_internal: 9.64%
  Perf report: # To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 48K of event 'cpu_core/cycles/'
# Event count (approx.): 268138966920
#
# Overhead       Samples  Command  Shared Object                           Symbol                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
# ........  ............  .......  ......................................  ..............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
#
    80.17%         38717  python3  caliby.cpython-310-x86_64-linux-gnu.so  [.] HNSW<hnsw_distance::SIMDAcceleratedL2>::searchLayer<false>
            |          
             --80.09%--HNSW<hnsw_distance::SIMDAcceleratedL2>::searchLayer<false>
                       |          
                        --80.09%--HNSW<hnsw_distance::SIMDAcceleratedL2>::addPoint_internal
                                  std::_Function_handler<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> (), std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::

  Identified 4 bottlenecks:
    1. searchLayer (80.2% cycles)
       Root cause: Excessive overhead in ID translation (integer division/mod), and use of C++ exceptions for OLC retries in the hot loop. The 'divq' at offset 100922 in assembly is a high-latency instruction repeated per neighbor.
    2. SIMDAcceleratedL2::compare (45.0% cycles)
       Root cause: AVX-512 implementation uses separate MUL/ADD instead of FMA (Fused Multiply-Add). While the i9-13900K theoretically has AVX-512 disabled, the library falls back to AVX2 which also benefits from better loop unrolling and FMA utilization.
    3. TwoLevelPageStateArray::get (12.0% cycles)
       Root cause: Thread-local storage (TLS) lookup for the 'IndexTranslationArray' occurs inside the 'searchLayer' inner loop. Caching this pointer once per search query instead of per-node access would eliminate redundant lookups.
    4. searchLayer (Candidate Management) (15.0% cycles)
       Root cause: Standard std::priority_queue operations involve significant branching and indirect calls. Using a fixed-size heap or a sorted array for small 'ef' values would improve IPC.
  Generated 2 optimization strategies:
    1. Eliminate Integer Division and Modulo from ID Translation
       Description: Replace high-latency division/modulo instructions with pre-calculated ID translation logic and bit-shifting where applicable.
       Expected: 1.25x speedup (confidence: 95%)
       Rationale: The assembly shows 'divq' consuming significant cycles in the search loop. Integer division on x86-64 is extremely expensive (20-80 cycles). By pre-calculating the shift/mask values in the HNSW constr
    2. AVX2 Distance Vectorization with FMA and Residual Unrolling
       Description: Improve AVX2 distance calculations using FMA and better loop unrolling for 13th Gen Intel hardware.
       Expected: 1.15x speedup (confidence: 90%)
       Rationale: The current AVX code manually performs sub and mul before adding. On the 13900K, FMA (Fused Multiply-Add) effectively doubles the floating point throughput and reduces the number of instructions in th
  Attempting strategy: Eliminate Integer Division and Modulo from ID Translation
     Target: searchLayer
     Expected: 1.25x
  Applying 1 code patch(es)
     ✅ Patch 1: /home/zxjcarrot/Workspace/caliby/src/hnsw.cpp
     Diff:
--- a//home/zxjcarrot/Workspace/caliby/src/hnsw.cpp
+++ b//home/zxjcarrot/Workspace/caliby/src/hnsw.cpp
@@ -654,12 +654,16 @@
 
 template <typename DistanceMetric>
 inline PID HNSW<DistanceMetric>::getNodePID(u32 node_id) const {
-    return base_pid + (node_id / NodesPerPage);
+    // Compiler generates optimized imul sequence for division by runtime constant if possible,
+    // but we help it here. We can further optimize if we know NodesPerPage is a power of 2.
+    return base_pid + (static_cast<u64>(node_id) / NodesPerPage);
 }
 
 template <typename DistanceMetric>
 inline u32 HNSW<DistanceMetric>::getNodeIndexInPage(u32 node_id) const {
-    return node_id % NodesPerPage;
+    // Replacing modulo with: id - (id / val) * val allows compiler to reuse the division result
+    u32 quotient = node_id / NodesPerPage;
+    return node_id - (quotient * NodesPerPage);
 }
 
 template <typename DistanceMetric>

  Rebuilding project...
     ✅ Build successful
  Running tests...
     ❌ Tests failed: Unknown
        Stdout: Calico module unloading: Shutting down system...
============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-8.4.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /home/zxjcarrot/Workspace/caliby
configfile: pytest.ini
plugins: anyio-4.11.0, asyncio-1.3.0, Faker-37.1.1, benchmark-5.1.0, xdist-3.8.0, forked-1.6.0
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 145 items

../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_import PASSED [  0%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_index_type_enum PASSED [  1%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_index_status_enum PASSED [  2%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_create_hnsw_config PASSED [  2%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_create_diskann_config PASSED [  3%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_create_index_config PASSED [  4%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogInstance::test_get_instance PASSED [  4%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogInstance::test_singleton_same_instance PASSED [  5%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogOperations::test_initialize_catalog PASSED [  6%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogOperations::test_list_empty_catalog PASSED [  6%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogOperations::test_create_hnsw_i
        Stderr: 
======================================================================
Iteration 2/5
======================================================================
Step 3.1: Profiling
  Profiling complete - 2 hot functions found
  Top hot functions:
    - HNSW<hnsw_distance::SIMDAcceleratedL2>::searchLayer<false>: 80.57%
    - HNSW<hnsw_distance::SIMDAcceleratedL2>::addPoint_internal: 10.12%
  Perf report: # To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 48K of event 'cpu_core/cycles/'
# Event count (approx.): 270405336086
#
# Overhead       Samples  Command  Shared Object                           Symbol                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
# ........  ............  .......  ......................................  ..............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
#
    80.57%         38925  python3  caliby.cpython-310-x86_64-linux-gnu.so  [.] HNSW<hnsw_distance::SIMDAcceleratedL2>::searchLayer<false>
            |          
             --80.54%--HNSW<hnsw_distance::SIMDAcceleratedL2>::searchLayer<false>
                       |          
                        --80.54%--HNSW<hnsw_distance::SIMDAcceleratedL2>::addPoint_internal
                                  std::_Function_handler<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> (), std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::

  Identified 3 bottlenecks:
    1. searchLayer (80.6% cycles)
       Root cause: The disassembly reveals 'divq' is still present (offsets 10088c and 1008ba), which are extremely high-latency instructions in the heart of the neighbor exploration loop. Additionally, the heap operations (vcomiss/jne/ja) for 'top_candidates' and 'candidate_queue' are incurring significant branch misprediction and comparison overhead.
    2. TwoLevelPageStateArray::get (15.0% cycles)
       Root cause: Repeated TLS lookups to find the IndexTranslationArray are performed inside the hot distance computation loop. While cached at the TLS level, the instruction overhead of accessing thread-local variables adds up over millions of distance calls.
    3. SIMDAcceleratedL2::compare (40.0% cycles)
       Root cause: Implicit inclusive cycles in searchLayer. The distance loop in distance.hpp is not exploiting the full 512-bit width of the 13900K (if enabled) or optimized FMA unrolling for AVX2, leading to port contention for arithmetic units.
  Generated 2 optimization strategies:
    1. Bypass TLS and Thread-Safe Caching for IndexTranslationArray
       Description: Extract the IndexTranslationArray pointer once at the start of searchBaseLayer and pass it through to all nested search calls, eliminating TLS lookups in the hot distance loop.
       Expected: 1.10x speedup (confidence: 95%)
       Rationale: Profiling identified TwoLevelPageStateArray::get (15% cycles) as a bottleneck due to TLS overhead inside the distance calculation loop. By resolving the IndexTranslationArray once per query (outside t
    2. Optimize AVX2 L2 Distance with FMA and Dual Accumulators
       Description: Refactor the AVX distance calculation to use FMA instructions and multiple accumulators to maximize 13900K pipeline utilization.
       Expected: 1.12x speedup (confidence: 90%)
       Rationale: The 13900K features high-performance FMA units on its P-cores. The existing AVX loop performs separate _mm256_sub_ps and _mm256_fmadd_ps. While the previous attempt failed due to 'Unknown' reasons, it
  Attempting strategy: Bypass TLS and Thread-Safe Caching for IndexTranslationArray
     Target: searchLayer
     Expected: 1.10x
  Applying 1 code patch(es)
     ✅ Patch 1: /home/zxjcarrot/Workspace/caliby/src/hnsw.cpp
     Diff:
--- a//home/zxjcarrot/Workspace/caliby/src/hnsw.cpp
+++ b//home/zxjcarrot/Workspace/caliby/src/hnsw.cpp
@@ -362,6 +362,7 @@
 
                 if (!(visited_array[neighbor_id] == visited_array_tag)) {
                     try {
+                        // Optimization: Pass pre-cached index_array to avoid TLS overhead in GuardORelaxed
                         GuardORelaxed<HNSWPage> neighbor_page_guard(getNodePID(neighbor_id), index_array);
                         NodeAccessor neighbor_acc(neighbor_page_guard.ptr, getNodeIndexInPage(neighbor_id), this);
 

  Rebuilding project...
     ✅ Build successful
  Running tests...
     ❌ Tests failed: Unknown
        Stdout: Calico module unloading: Shutting down system...
============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-8.4.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /home/zxjcarrot/Workspace/caliby
configfile: pytest.ini
plugins: anyio-4.11.0, asyncio-1.3.0, Faker-37.1.1, benchmark-5.1.0, xdist-3.8.0, forked-1.6.0
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 145 items

../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_import PASSED [  0%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_index_type_enum PASSED [  1%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_index_status_enum PASSED [  2%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_create_hnsw_config PASSED [  2%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_create_diskann_config PASSED [  3%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogBasic::test_create_index_config PASSED [  4%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogInstance::test_get_instance PASSED [  4%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogInstance::test_singleton_same_instance PASSED [  5%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogOperations::test_initialize_catalog PASSED [  6%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogOperations::test_list_empty_catalog PASSED [  6%]
../../home/zxjcarrot/Workspace/caliby/tests/test_catalog.py::TestCatalogOperations::test_create_hnsw_i
        Stderr: 
======================================================================
Iteration 3/5
======================================================================
Step 3.1: Profiling
  Profiling complete - 3 hot functions found
  Top hot functions:
    - HNSW<hnsw_distance::SIMDAcceleratedL2>::searchLayer<false>: 80.38%
    - HNSW<hnsw_distance::SIMDAcceleratedL2>::addPoint_internal: 10.12%
    - BufferManager::prefetchPages2Level: 4.96%
  Perf report: # To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 46K of event 'cpu_core/cycles/'
# Event count (approx.): 256201432646
#
# Overhead       Samples  Command  Shared Object                           Symbol                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
# ........  ............  .......  ......................................  ..............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
#
    80.38%         36853  python3  caliby.cpython-310-x86_64-linux-gnu.so  [.] HNSW<hnsw_distance::SIMDAcceleratedL2>::searchLayer<false>
            |          
             --80.35%--HNSW<hnsw_distance::SIMDAcceleratedL2>::searchLayer<false>
                       HNSW<hnsw_distance::SIMDAcceleratedL2>::addPoint_internal
                       std::_Function_handler<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> (), std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<

  Identified 3 bottlenecks:
    1. searchLayer (80.4% cycles)
       Root cause: Disassembly shows 'divq' (offsets 10065c, 10068a) stalling the pipeline for 20-80 cycles per neighbor evaluation. This is caused by the mapping from global node IDs to page IDs and offsets which happens redundantly.
    2. TwoLevelPageStateArray::get (15.2% cycles)
       Root cause: Thread-local storage (TLS) access for IndexTranslationArray is performed inside the hot distance loops within GuardORelaxed constructors. On many-core Intel systems, the constant recalculation of the TLS offset is non-trivial compared to a direct pointer access.
    3. candidate_queue maintenance (12.0% cycles)
       Root cause: Assembly shows high density of vcomiss/jne/ja instructions. Using std::priority_queue for 'ef' search results leads to many small heap property fixes (log(ef) complexity but high constant factor and branching).
  Generated 2 optimization strategies:
    1. Greedy Search Path Branch Fix
       Description: Optimize the findBestEntryPointForLevel greedy search by reducing redundant state transitions and improving instruction flow in the greedy hill-climbing phase.
       Expected: 1.05x speedup (confidence: 80%)
       Rationale: Profiling shows searchLayer and its callers (like findBestEntryPointForLevel) dominate the CPU time. The greedy search at upper levels currently recalculates 'best_neighbor_id' and performs multiple n
    2. Loop-Hoist Query Prefetch
       Description: Improve distance computation timing by pre-fetching the query vector into L1 cache once per query layer search.
       Expected: 1.03x speedup (confidence: 85%)
       Rationale: The 13900K has a high number of cores competing for cache bandwidth. While individual distance functions use SIMD, the query vector itself is accessed millions of times across different HNSW nodes. Ex
  Attempting strategy: Greedy Search Path Branch Fix
     Target: searchLayer
     Expected: 1.05x
  Applying 1 code patch(es)
     ✅ Patch 1: /home/zxjcarrot/Workspace/caliby/src/hnsw.cpp
     Diff:
--- a//home/zxjcarrot/Workspace/caliby/src/hnsw.cpp
+++ b//home/zxjcarrot/Workspace/caliby/src/hnsw.cpp
@@ -321,7 +321,9 @@
         u32 best_neighbor_id = current_node_id;
 
         try {
-            GuardS<HNSWPage> current_page_guard(getNodePID(current_node_id));
+            PID current_pid = getNodePID(current_node_id);
+            GuardS<HNSWPage> current_page_guard(current_pid);
+            NodeAccessor current_acc(current_page_guard.ptr, getNodeIndexInPage(current_node_id), this);
             NodeAccessor current_acc(current_page_guard.ptr, getNodeIndexInPage(current_node_id), this);
 
             // The first node is marked as visited here.

  Rebuilding project...
     ❌ Build failed after fix attempts:
/home/zxjcarrot/Workspace/caliby/src/hnsw.cpp:327:26: error: redeclaration of ‘HNSW<DistanceMetric>::NodeAccessor current_acc’
/home/zxjcarrot/Workspace/caliby/src/hnsw.cpp:327:26: error: redeclaration of ‘HNSW<DistanceMetric>::NodeAccessor current_acc’
  error: subprocess-exited-with-error
      /home/zxjcarrot/Workspace/caliby/src/hnsw.cpp:327:26: error: redeclaration of ‘HNSW<DistanceMetric>::NodeAccessor current_acc’
      subprocess.CalledProcessError: Command '['cmake', '--build', '.', '--config', 'Release', '-j', '32']' returned non-zero exit status 2.
  ERROR: Failed building editable for caliby
error: failed-wheel-build-for-install
======================================================================
Iteration 4/5
======================================================================
❌ Aborting: 3 consecutive failures detected - system may be in broken state
